# Codex CLI Sandbox 机制设计报告

本报告总结了 Codex CLI 中 @sandbox（沙盒执行）机制的设计目标、核心实现、模块分工，以及如何在自定义 Agent 中实现类似机制的建议。

---

## 1. 设计目标与意义

- **安全隔离**：防止 Agent 执行的命令对用户系统造成不可控的破坏。
- **最小权限原则**：只允许 Agent 在受控范围内读写文件、执行命令。
- **跨平台支持**：兼容 macOS、Linux 等主流开发环境。
- **可扩展性**：便于未来支持更多沙盒类型或权限策略。

---

## 2. 支持的沙盒类型

### 2.1 macOS Seatbelt
- 利用 macOS 原生的 seatbelt 沙盒机制（通过 `sandbox-exec` 工具）。
- 支持只读、指定目录可写、网络访问控制等。
- 策略通过 Scheme 风格的策略文本动态生成。

### 2.2 Linux Landlock
- 利用 Linux 内核的 Landlock 安全模块。
- 通过系统调用限制进程的文件系统访问权限。
- 支持指定目录可写、只读、禁止访问等。

### 2.3 Raw/None
- 不做沙盒隔离，直接在宿主系统执行命令。
- 仅用于本地开发、测试或信任环境。

---

## 3. 核心模块功能与协作

### 3.1 macos-seatbelt.ts
- 动态生成 seatbelt 策略文本，支持只读/可写/网络权限配置。
- 通过 `sandbox-exec` 启动子进程，应用策略。
- 处理命令执行的输入输出、错误捕获。

### 3.2 landlock.ts
- 构建 Landlock 权限规则，限制进程对文件系统的访问。
- 通过 C/C++/Rust FFI 或 Node.js 原生扩展调用内核接口。
- 启动受限子进程，捕获执行结果。

### 3.3 raw-exec.ts
- 直接用 Node.js `child_process.spawn` 执行命令。
- 不做额外隔离，仅用于无沙盒场景。

### 3.4 interface.ts
- 定义沙盒类型（SandboxType 枚举）、命令输入输出结构（ExecInput/ExecResult）。
- 统一各平台沙盒实现的接口。

### 3.5 create-truncating-collector.ts
- 辅助收集命令输出，防止输出过大导致内存溢出。
- 支持输出截断、流式收集。

---

## 4. 典型执行流程

1. **命令准备**：Agent 生成待执行的 shell 命令及参数。
2. **选择沙盒类型**：根据平台和配置，选择 Seatbelt、Landlock 或 Raw。
3. **策略生成**：如需沙盒，动态生成权限策略（如 seatbelt policy）。
4. **命令执行**：通过对应模块（如 `sandbox-exec` 或 Landlock FFI）启动受控子进程。
5. **权限控制**：只允许访问指定目录、只读/可写、网络访问等。
6. **输出收集**：用 create-truncating-collector 收集 stdout/stderr，防止输出过大。
7. **错误处理**：捕获执行异常、权限拒绝、超时等，反馈给 Agent。

---

## 5. 在自定义 Agent 中实现沙盒机制的建议

1. **平台检测**：根据运行环境自动选择合适的沙盒实现。
2. **策略灵活配置**：支持动态指定可写目录、只读目录、网络权限等。
3. **最小权限原则**：默认只读，按需开放写权限，防止越权。
4. **输出截断与监控**：防止命令输出过大导致资源耗尽。
5. **错误与异常处理**：清晰反馈权限拒绝、超时、命令失败等。
6. **可扩展性**：为未来支持更多平台或更细粒度权限控制预留接口。
7. **安全默认**：生产环境下强制启用沙盒，开发/测试环境可选择关闭。

---

通过上述设计，您可以在自定义 Agent 中实现类似 Codex CLI 的沙盒安全机制，最大限度保障命令执行的安全性和可控性。 